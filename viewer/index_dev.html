<html>

<head>
<title>text overlay</title>

<script type="text/javascript" src="jquery-1.5.js"></script>
<script type="text/javascript" src="jquery.mousewheel.min.js"></script>
<script type="text/javascript">

var sDataPath = "data2/";
var oImageSize = {};
var oPageSize = {};
var oScale = {};
var scaleListeners = [];
mouse_mode = "pan";
var lastWordSize = 100;

function debug(msg) {
	debuglog(msg);

}

$(document).ready(function() {

	buildPageChanger();
	loadPage("0001");
	    	
	    	
	$("#text_overlay").mousewheel(function(e, delta) {
		e.preventDefault();
		
		var zoomDiff;
		
		if (delta > 0) {
			zoomDiff = 0.1;
		} else {
			zoomDiff = -0.1;
		}
		
		
		var preViewportSize = getScaledImageSize();
		debuglog(getViewportPosition());

		var XYKerroin = {
			x: $('#text_overlay').width() / mouseX,
			y: $('#text_overlay').height() / mouseY
		}
		

		postViewportSize = {
			width: $("#text_overlay").width() / (zoom + zoomDiff)
			,height: $("#text_overlay").height() / (zoom + zoomDiff)
		};
			
		setViewportZoom(getViewportZoom() + zoomDiff);
	
	
		postViewportSize = getScaledImageSize();
		var diffX = postViewportSize.width - preViewportSize.width;
		var diffY = postViewportSize.height - preViewportSize.height;

		oViewportPosition = getViewportPosition();
		
		oViewportPosition.x -= diffX / XYKerroin.x;
		oViewportPosition.y -= diffY / XYKerroin.y;
			
		setViewportPosition(oViewportPosition.x, oViewportPosition.y);
		
		
		loadTexts(currPage);
		
	});
	
	$("#text_overlay").mousedown(function(e) {
		
		if (mouse_mode == 'pan') {
			e.preventDefault();
			panning = true;
		}
	});
	$("#text_overlay").mouseup(function(e) {
		e.preventDefault();
		
		panning = false;
	});
	
	$("#text_overlay").mouseout(function(e) {
		
		panning = false;
	});
	
	$("#text_overlay").mousemove(function(e) {

		mouseXlast = mouseX || 0;
		mouseYlast = mouseY || 0;
		
		mouseX = e.clientX - $(this).offset().left;
		mouseY = e.clientY - $(this).offset().top;

		
		if (panning) {
		
			oViewportPosition = getViewportPosition();
			
			mouseXdiff = mouseXlast - mouseX;
			mouseYdiff = mouseYlast - mouseY;
			
			oViewportPosition.x -= mouseXdiff;
			oViewportPosition.y -= mouseYdiff;
			

			setViewportPosition(oViewportPosition.x, oViewportPosition.y);
			
			loadTexts(currPage);
		}
	});

});

var mouseX, mouseY, mouseXlast, mouseYlast;

var panning = false;


function buildPageChanger() {
	var lastPage = 20;
	
	for (var i=1;i<=lastPage;i++) {
		$pageLink = $("<span>" + i + " </span>");
		$('#pages').append($pageLink);
		
		$pageLink.click(function() {
		
			num = $(this).text().trim();
			while (num.length < 4) {
				num = "0" + num;
			}
			loadPage(num);
		
		});
	}

}

onScaleReady(function() {
	buildImageIndex();		
});

var imgIndexReady = false;

function buildImageIndex() {
	if (imgIndexReady) {
		return;
	}
	
	$("#imageindex .content_items").html('');

	$.get(sDataPath + "imageIndex.xml?a", function(data) {

		$(data).find("GraphicalElement").each(function() {

			var left =  $(this).attr('VPOS');
			var top = $(this).attr('HPOS');
			var width = $(this).attr('WIDTH');
			var height =  $(this).attr('HEIGHT');
			var page = $(this).attr('PAGE');
			var file = $(this).attr('FILE');
			
			
			$.get(sDataPath + "img.pl", 
			  {
			     scaleWidth: oScale.width
			    ,scaleHeight: oScale.height
			    ,top: top
			    ,left: left
			    ,width: width
			    ,height: height
			    ,file: file
			  }
			  , function(data, status, $xhr) {
		
			  	
			  	$imgLink = $("<img src='data:image/jpg;base64," + data.image +"'/ >");
			  	$imgLink.width(200);
			  	$imgLink.css('margin-bottom', '10px');
			  	$imgLink.attr('page', page);
			  	
			  	$("#imageindex .content_items").append($imgLink);
			  	
			
			  	$imgLink.click(function() {
					num = $(this).attr('page');
					while (num.length < 4) {
						num = "0" + num;
					}
					loadPage(num);
				
				});
				
			  });

			
		});
		
		imgIndexReady = true;
	});

}



$(document).ready(function() {
	buildIndex();

});


function buildIndex() {

	$("#index .content_items").html('');

	$.get(sDataPath + "mets.xml", function(data) {
	
		$(data).find("div[TYPE='CHAPTER']").each(function() {
		
			label = $(this).attr('LABEL');
			
			$file = $(this).find('area[FILEID]').first();
			
			
			page = fileIDToPageNum ( $file.attr('FILEID') );
			debuglog(page);
			if (page != null) {
				$li = $("<li page='"+ page +"'>"+ label +"</li>");
				$("#index .content_items").append($li);
				
				$li.click(function() {
					num = $(this).attr('page');
					while (num.length < 4) {
						num = "0" + num;
					}
					loadPage(num);
				
				});
			}
		});
		
	
	});

}

//ALTO00015
function fileIDToPageNum(sFileID) {


	var re = new RegExp("(\\d+)","gi");

	var match = re.exec(sFileID);
	
	if (match[1] != undefined) {
		return parseInt(match[1],10);
	}

	return null;
}


function loadPage(num) {
	$("#text_overlay").empty();
	loadImage(num);	
}

var Xpx;
var Ypx;
var zoom;

function getViewerSize() {

	fWidth = $("#text_overlay").width();
	fHeight = $("#text_overlay").height();
	return { width: fWidth, height: fHeight };
}

function getViewerPosition() {
	return $("#text_overlay").offset();
}

function getViewerBounds() {

	var pos = getViewerPosition();

	var size = getViewerSize();
	
	return {
		left: pos.left,
		right: pos.left + size.width,
		top: pos.top,
		bottom: pos.top + size.height
	};

}

function getScaledImageSize() {

	width = oImageSize.width * oImageSize.scale;
	height = oImageSize.height * oImageSize.scale;

	return { width: width, height: height };
}

function getViewportSize() {

	fWidth = $("#text_overlay").width() / zoom;
	fHeight = $("#text_overlay").height() / zoom;

	return { width: fWidth, height: fHeight };
}

function getViewportPosition() {

	return {x: Xpx, y: Ypx };
}

function setViewportPosition(x,y) {

	Xpx = x;
	Ypx = y;

	x += oImageSize.left;
	y += oImageSize.top;
	
	sCSSPosition = x + 'px' + ' ' + y + 'px';

	$("#text_overlay").css('background-position', sCSSPosition );

}

function getViewportZoom() {
	return zoom;
}

function setViewportZoom(percent) {

	if (percent < 1 || percent > 3) {
		return;
	}

	elemHeight = $("#text_overlay").height();
	
	var h = elemHeight * percent;
	var w = elemHeight * oImageSize.ratio * percent;

	zoom = percent;
	$("#text_overlay").css('background-size', w + "px " + h + "px");
	$("#text_overlay").css('-moz-background-size',  w + "px " + h + "px");
	oImageSize.scale = w / oImageSize.width;
}

var imageScale;

function loadImage(num) {

	bgImage = new Image();
	bgImage.src= sDataPath + num + ".jpg";

	$(bgImage).load(function() {

		oImageSize = { width: bgImage.width, height: bgImage.height, ratio: bgImage.width / bgImage.height};


		elemWidth = $("#text_overlay").width();
		elemHeight = $("#text_overlay").height();
		var w = elemHeight * oImageSize.ratio;
		oImageSize.left = (elemWidth-w)/2;
		oImageSize.top = 0;
			
		oImageSize.scale = w / oImageSize.width;
	
	
		setViewportZoom(1);
		
	
		setViewportPosition(0,0);


		$("#text_overlay").css('background-image', 'url('+ bgImage.src +')');
	

		loadTexts(num);
	});
		
}

var pageXML = {};
var currPage;

function loadTexts(num) {
	currPage = num;
	if (pageXML[num] == undefined) {
	
	
		$.get( sDataPath + num + '.xml', function(data) {
		
			$page = $(data).find('Page').first();
			oPageSize = { height: $page.attr('HEIGHT'), width:  $page.attr('WIDTH') };
			
			oScale = {
				 width: oImageSize.width / oPageSize.width 
				,height:  oImageSize.height / oPageSize.height
			}
			triggerScaleReady();
			
			pageXML[num] = {
				"data": data
				,"scale": oScale
			};
			
		
			
			renderText(pageXML[num].data);
			
		
		});
	
	} else {
	
			oScale = pageXML[num].scale;
			
			
			
			
			renderText(pageXML[num].data);
			
	}



}


function triggerScaleReady() {
	for (i=0;i<scaleListeners.length;i++) {
	
		scaleListeners[i]();
	}
}
function onScaleReady(callback) {
	scaleListeners.push(callback);
}



var timer;

function renderText(data) {

	$("#text_overlay").html('');
	
	if (timer != undefined) {
		clearTimeout(timer);
	}
	timer = setTimeout(function() {
	
		$(data).find('String').each(function() {
		
			render_string($(this));
		
		});
	}, 1500);
	
}

function render_string($oString) {

	oViewportPosition = getViewportPosition();

	var left = $oString.attr('HPOS') * oScale.width * oImageSize.scale + oViewportPosition.x + oImageSize.left;
	var top = $oString.attr('VPOS')  * oScale.height * oImageSize.scale + oViewportPosition.y + oImageSize.top;
	
	
	bounds = getViewerSize();
	
	
	//Dont create stringelements if they're out of bounds
	if (left < 0 || left > bounds.width ||
		top < 0 || top > bounds.height) {

		return;
	}


	
	
	var width = $oString.attr('WIDTH') * oScale.width * oImageSize.scale;
	var height = $oString.attr('HEIGHT') * oScale.height * oImageSize.scale;
	
	var content = $oString.attr('CONTENT');
	var fontFace = "Times New Roman"; 
	
	//Create boundingBox
	var $bb = $("<span class='boundingbox'></span>");
	//Content
	var $content = $("<span class='text'>"+ content +"<span>");
	
	$bb.append($content);
	
	$bb.css('position', 'absolute');
	$bb.css('width', width);
	$bb.css('height', height);
	$bb.css('top', top);
	$bb.css('left', left);
	$bb.css('line-height', height + "px");
	
	
	
	$("#text_overlay").append($bb);
	
	resize_text($bb);
}

function resize_text($bb) {

		var fontSize = lastWordSize;
		var innerText = $bb.find('.text');
		var maxWidth = $bb.width();
		innerText.css('font-size', fontSize);
		textWidth = innerText.width();
	
		if (textWidth > maxWidth) {
	
			do {
				innerText.css('font-size', fontSize);
			   
				textWidth = innerText.width();
				fontSize = fontSize - 1;

			 } while (textWidth > maxWidth && fontSize > 3);

		} else {
			do {
				innerText.css('font-size', fontSize);
			   
				textWidth = innerText.width();
				fontSize = fontSize + 1;

			 } while (textWidth < maxWidth && fontSize < 100);
		
		}

		lastWordSize = fontSize;
}

function debuglog(msg) {
	if (window.console && console.log) {
		console.log(msg);
	}

}

$(document).ready(function() {
	$("#pan").click(function() { setmode(this); });
	$("#select").click(function() { setmode(this); });
});

function setmode(item) {

	mode = $(item).attr('id');
	
	$(item).addClass('selected');

	mouse_mode = mode;
	if (mode == 'pan') {
		$("#select").removeClass('selected');
		
		$("#text_overlay").css('cursor', 'default');
		$("#text_overlay span").css('cursor', 'default');
	}

	if (mode == 'select') {
		$("#pan").removeClass('selected');
		$("#text_overlay").css('cursor', 'text');
		$("#text_overlay span").css('cursor', 'text');
	}
	
}

</script>

<style type="text/css">
#text_overlay {
	position: relative;
	border: 1px solid black;	
	height: 700px;
	width: 900px;
	background-repeat: no-repeat;
	display: inline-block;
}

#text_overlay span {
	cursor: default;
}

.text {
	color: rgba(0,0,0,0);
	border: 1px solid black;	
	
}

#top_toolbars {
	margin-left: 125px;
	width: 900px;
	clear:both;
	height: 28px;
}

#pages {
	
	display: inline-block;
}
#toolbar {
	display: inline-block;
	float: right;
}

#toolbar div.selected {
	background-color: #dddddd;
}

#pages span {
	
	cursor: pointer;
	
}
#index {
	display: inline-block;
	vertical-align: top;
	width: 120px;
}
#index .content_items li {
	cursor: pointer;
	list-style: none;
}

#imageindex {
	display: inline-block;
	width: 200px;
	height: 700px;
	border: 1px solid black;
	vertical-align: top;
}
#imageindex img {
	cursor: pointer;

}

.icon_pan {
	cursor: pointer;
	background-image: url(img/select_pan.png);
	width: 24px;
	height: 24px;
	border: 1px solid black;
	background-position: -24px 0px;
	display: inline-block;
}

.icon_select {
	cursor: pointer;
	background-image: url(img/select_pan.png);
	width: 24px;
	height: 24px;
	border: 1px solid black;
	display: inline-block;
}
</style>

</head>

<body>

<div id="top_toolbars">
<div id="pages">Sivu: </div>
<div id="toolbar"><div id="pan" class="selected icon_pan"></div><div id="select" class="icon_select"></div></div>
</div>

<div id="index">
Sisällysluettelo
	<div class="content_items"></div>
</div>


<div id="text_overlay"></div>

	<div id="imageindex">
	
		<div class="content_items">Latadataan</div>
	</div>


</body>

</html>
