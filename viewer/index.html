<html>

<head>
<title>text overlay</title>

<script type="text/javascript" src="jquery-1.5.js"></script>
<script type="text/javascript" src="jquery.mousewheel.min.js"></script>
<script type="text/javascript" src="jquery.query-2.1.7.js"></script>
<script type="text/javascript">

var sDataPath = "/mets_viewer/packages/";
var oImageSize = {};
var oPageSize = {};
var oScale = {};
var scaleListeners = [];
mouse_mode = "pan";
var lastWordSize = 100;

function debug(msg) {
	debuglog(msg);

}

function currentPage() {
		var pagehashPattern = new RegExp('#page=(\\d+)','gi');

		var matches = pagehashPattern.exec(window.location.hash);
		if (matches == null) {
			return 1;
		}
		if (matches.length > 1) {
			return parseInt(matches[1], 10);
		}
		
		return null;
		

}

$(document).ready(function() {

	$(window).bind('hashchange', function() {

		loadPage(currentPage());
		triggerPagechange();
		
		
	});


	page = $.query.get('page') || 1;
	sDataPath += $.query.get('item') + "/";

	loadPage(page);
	
	buildPageChanger();
	
		
	$("#text_overlay").mousewheel(function(e, delta) {
		e.preventDefault();
		
		var zoomDiff;
		
		if (delta > 0) {
			zoomDiff = 0.1;
		} else {
			zoomDiff = -0.1;
		}
		
		
		var preViewportSize = getScaledImageSize();
		debuglog(getViewportPosition());

		var XYKerroin = {
			x: $('#text_overlay').width() / mouseX,
			y: $('#text_overlay').height() / mouseY
		}
		

		postViewportSize = {
			width: $("#text_overlay").width() / (zoom + zoomDiff)
			,height: $("#text_overlay").height() / (zoom + zoomDiff)
		};
			
		setViewportZoom(getViewportZoom() + zoomDiff);
	
	
		postViewportSize = getScaledImageSize();
		var diffX = postViewportSize.width - preViewportSize.width;
		var diffY = postViewportSize.height - preViewportSize.height;

		oViewportPosition = getViewportPosition();
		
		oViewportPosition.x -= diffX / XYKerroin.x;
		oViewportPosition.y -= diffY / XYKerroin.y;
			
		setViewportPosition(oViewportPosition.x, oViewportPosition.y);
		
		
		loadTexts(currPage);
		
	});
	
	$("#text_overlay").mousedown(function(e) {
		
		if (mouse_mode == 'pan') {
			e.preventDefault();
			panning = true;
		}
	});
	$("#text_overlay").mouseup(function(e) {
		e.preventDefault();
		
		panning = false;
	});
	
	$("#text_overlay").mouseout(function(e) {
		
		panning = false;
	});
	
	$("#text_overlay").mousemove(function(e) {

		mouseXlast = mouseX || 0;
		mouseYlast = mouseY || 0;
		
		mouseX = e.clientX - $(this).offset().left;
		mouseY = e.clientY - $(this).offset().top;

		
		if (panning) {
		
			oViewportPosition = getViewportPosition();
			
			mouseXdiff = mouseXlast - mouseX;
			mouseYdiff = mouseYlast - mouseY;
			
			oViewportPosition.x -= mouseXdiff;
			oViewportPosition.y -= mouseYdiff;
			

			setViewportPosition(oViewportPosition.x, oViewportPosition.y);
			
			loadTexts(currPage);
		}
	});

});

var mouseX, mouseY, mouseXlast, mouseYlast;

var panning = false;
var pagechangeListeners = [];
function triggerPagechange() {
	for (i=0;i<pagechangeListeners.length;i++) {
	
		pagechangeListeners[i]();
	}
}

function onPageChanged(callback) {
	pagechangeListeners.push(callback);
}

var pageChangeTimeout;

function buildPageChanger() {
	var lastPage = 20;
	
	
	$("#pages").html('');

	$.get(sDataPath + "mets.xml", function(data) {
	
		count = $(data).find("file[MIMETYPE='text/xml']").length;
		
	
		$first = $("<a class='ui-state-default ui-corner-all'><span class='ui-icon ui-icon-arrowthickstop-1-w'></span></a>");
		$last = $("<a class='ui-state-default ui-corner-all'><span class='ui-icon ui-icon-arrowthickstop-1-e'></span></a>");
		
		$prev = $("<a class='ui-state-default ui-corner-all'><span class='ui-icon ui-icon-triangle-1-w'></span></a>");
		$next = $("<a class='ui-state-default ui-corner-all'><span class='ui-icon ui-icon-triangle-1-e'></span></a>");
		
		$pageChanger = $("<input id='pageChanger' type='text'></input'>");
		$pageChanger.val(currentPage());
		
		onPageChanged(function() {
			$("#pageChanger").val(currentPage());
		});
		$pageChanger.keyup(function(event) {
			if (pageChangeTimeout != undefined) {
				clearTimeout(pageChangeTimeout);
			}
			pageChangeTimeout = setTimeout(function() {
			
				var newPage = $pageChanger.val();
				if (newPage > 0 && newPage <= count) {
				
					location.href = '#page='+newPage;
				
				}
			
			}, 1000);
		
		
		});
		
		$('#pages').append($first);
		$('#pages').append($prev);
		$('#pages').append($pageChanger);
		$('#pages').append($next);
		$('#pages').append($last);
		
		$first.attr('href','#page=1');
		$last.attr('href','#page='+count);
		
		$next.click(function() {
			newPage = currentPage()+1;
			if (newPage > count) {
				return;
			}
			location.href = '#page='+newPage;
		});
		
		$prev.click(function() {
			newPage = currentPage()-1;
			if (newPage < 1) {
				return;
			}
			location.href = '#page='+newPage;
		});
		
		$('#pages a').hover(
			function() {
				$(this).addClass('ui-state-hover');
			},
			function() {
				$(this).removeClass('ui-state-hover');
			});
		});
	


}

onScaleReady(function() {
	buildImageIndex();		
});

var imgIndexReady = false;

function buildImageIndex() {
	if (imgIndexReady) {
		return;
	}
	
	$("#imageindex .content_items").html('');

	$.get(sDataPath + "imageIndex.xml?sa", function(data) {
	
		$(data).find("anon").each(function() {

	
			file = $(this).find('imagename').first().text();
			page = $(this).find('pagenumber').first().text();
			$imgLink = $("<a href='#page="+page+"'></a>");
			$img = $("<img src='"+sDataPath + file+"'/ >");
			$img.width(200);
			$img.css('margin-bottom', '10px');
			$imgLink.attr('page', page);
			$imgLink.append($img);
			
			
			$img.ready(function() {
				$("#imageindex .content_items").append($imgLink);
			
				
				$imgLink.click(function() {
					num = $(this).attr('page');
					while (num.length < 4) {
						num = "0" + num;
					}
					loadPage(num);
				
				});
				
				
			});

		});
		
		imgIndexReady = true;
	});

}


$(document).ready(function() {
	buildIndex();

});


function buildIndex() {

	$("#index .content_items").html('');

	$.get(sDataPath + "mets.xml", function(data) {
	
		$(data).find("div[TYPE='CHAPTER']").each(function() {
		
			label = $(this).attr('LABEL');
			
			$file = $(this).find('area[FILEID]').first();
	
			page = fileIDToPageNum ( $file.attr('FILEID') );
			debuglog(page);
			
			if (page != null) {
				$li = $("<li></li>");
				$a = $("<a page='"+page+"' href='#page="+page+"'>"+ label +"</a>");
				$li.append($a);
				$("#index .content_items").append($li);
				
				$a.click(function() {
					num = $(this).attr('page');
					while (num.length < 4) {
						num = "0" + num;
					}
					loadPage(num);
				
				});
			}
		});
		
	
	});

}


function fileIDToPageNum(sFileID) {


	var re = new RegExp("(\\d+)","gi");

	var match = re.exec(sFileID);
	
	if (match[1] != undefined) {
		return parseInt(match[1],10);
	}

	return null;
}


function loadPage(num) {
	num = "" + num;
	while (num.length < 4) {
		num = "0" + num;
	}
	
	$("#text_overlay").empty();

	loadImage(num);	
}

	
var Xpx;
var Ypx;
var zoom;

function getViewerSize() {

	fWidth = $("#text_overlay").width();
	fHeight = $("#text_overlay").height();
	return { width: fWidth, height: fHeight };
}

function getViewerPosition() {
	return $("#text_overlay").offset();
}

function getViewerBounds() {

	var pos = getViewerPosition();

	var size = getViewerSize();
	
	return {
		left: pos.left,
		right: pos.left + size.width,
		top: pos.top,
		bottom: pos.top + size.height
	};

}

function getScaledImageSize() {

	width = oImageSize.width * oImageSize.scale;
	height = oImageSize.height * oImageSize.scale;

	return { width: width, height: height };
}

function getViewportSize() {

	fWidth = $("#text_overlay").width() / zoom;
	fHeight = $("#text_overlay").height() / zoom;

	return { width: fWidth, height: fHeight };
}

function getViewportPosition() {

	return {x: Xpx, y: Ypx };
}

function setViewportPosition(x,y) {

	Xpx = x;
	Ypx = y;

	x += oImageSize.left;
	y += oImageSize.top;
	
	sCSSPosition = x + 'px' + ' ' + y + 'px';

	$("#text_overlay").css('background-position', sCSSPosition );

}

function getViewportZoom() {
	return zoom;
}

function setViewportZoom(percent) {

	if (percent < 1 || percent > 3) {
		return;
	}

	elemHeight = $("#text_overlay").height();
	
	var h = elemHeight * percent;
	var w = elemHeight * oImageSize.ratio * percent;

	zoom = percent;
	$("#text_overlay").css('background-size', w + "px " + h + "px");
	$("#text_overlay").css('-moz-background-size',  w + "px " + h + "px");
	oImageSize.scale = w / oImageSize.width;
}

var imageScale;

function loadImage(num) {

	smallImage = new Image();
	smallImage.src= sDataPath + "small-" + num + ".jpg";
	
	$(smallImage).load(function() {

		oImageSize = { width: smallImage.width, height: smallImage.height, ratio: smallImage.width / smallImage.height};


		elemWidth = $("#text_overlay").width();
		elemHeight = $("#text_overlay").height();
		var w = elemHeight * oImageSize.ratio;
		oImageSize.left = (elemWidth-w)/2;
		oImageSize.top = 0;
			
		oImageSize.scale = w / oImageSize.width;
	
	
		setViewportZoom(1);
	
		setViewportPosition(0,0);

		$("#text_overlay").css('background-image', 'url('+ smallImage.src +')');
	
	
	
		
		bgImage = new Image();
		bgImage.src= sDataPath + num + ".jpg";

		$(bgImage).load(function() {

			oImageSize = { width: bgImage.width, height: bgImage.height, ratio: bgImage.width / bgImage.height};


			elemWidth = $("#text_overlay").width();
			elemHeight = $("#text_overlay").height();
			var w = elemHeight * oImageSize.ratio;
			oImageSize.left = (elemWidth-w)/2;
			oImageSize.top = 0;
			
			oImageSize.scale = w / oImageSize.width;
	
	
			setViewportZoom(1);
		
	
			setViewportPosition(0,0);


			$("#text_overlay").css('background-image', 'url('+ bgImage.src +')');
	

			loadTexts(num);
		});
		
		
	});
}

var pageXML = {};
var currPage;

function loadTexts(num) {
	currPage = num;
	if (pageXML[num] == undefined) {
	
	
		$.get( sDataPath + num + '.xml', function(data) {
		
			$page = $(data).find('Page').first();
			oPageSize = { height: $page.attr('HEIGHT'), width:  $page.attr('WIDTH') };
			
			oScale = {
				 width: oImageSize.width / oPageSize.width 
				,height:  oImageSize.height / oPageSize.height
			}
			triggerScaleReady();
			
			pageXML[num] = {
				"data": data
				,"scale": oScale
			};
			
		
			
			renderText(pageXML[num].data);
			
		
		});
	
	} else {
	
			oScale = pageXML[num].scale;
			
			
			
			
			renderText(pageXML[num].data);
			
	}



}


function triggerScaleReady() {
	for (i=0;i<scaleListeners.length;i++) {
	
		scaleListeners[i]();
	}
}
function onScaleReady(callback) {
	scaleListeners.push(callback);
}



var timer;

function renderText(data) {

	$("#text_overlay").html('');
	
	if ($("#text_overlay").css('cursor') != 'wait') {
		preCursor = $("#text_overlay").css('cursor');
	
		if (preCursor == 'text') {
			$("#text_overlay").css('cursor', 'wait');
		}
	}
		
	if (timer != undefined) {
		clearTimeout(timer);
	}
	timer = setTimeout(function() {
	
		$(data).find('String').each(function() {
		
			render_string($(this));
		
		});
		
		$("#text_overlay").css('cursor', preCursor);
		$("#text_overlay span").css('cursor', preCursor);
		
	}, 1500);
	
}

function render_string($oString) {

	oViewportPosition = getViewportPosition();

	var left = $oString.attr('HPOS') * oScale.width * oImageSize.scale + oViewportPosition.x + oImageSize.left;
	var top = $oString.attr('VPOS')  * oScale.height * oImageSize.scale + oViewportPosition.y + oImageSize.top;
	
	
	bounds = getViewerSize();
	
	
	//Dont create stringelements if they're out of bounds
	if (left < 0 || left > bounds.width ||
		top < 0 || top > bounds.height) {

		return;
	}


	
	
	var width = $oString.attr('WIDTH') * oScale.width * oImageSize.scale;
	var height = $oString.attr('HEIGHT') * oScale.height * oImageSize.scale;
	
	var content = $oString.attr('CONTENT');
	var fontFace = "Times New Roman"; 
	
	//Create boundingBox
	var $bb = $("<span class='boundingbox'></span>");
	//Content
	var $content = $("<span class='text'>"+ content +"<span>");
	
	$bb.append($content);
	
	$bb.css('position', 'absolute');
	$bb.css('width', width);
	$bb.css('height', height);
	$bb.css('top', top);
	$bb.css('left', left);
	$bb.css('line-height', height + "px");
	
	
	
	$("#text_overlay").append($bb);
	
	resize_text($bb);
}

function resize_text($bb) {

		var fontSize = lastWordSize;
		var innerText = $bb.find('.text');
		var maxWidth = $bb.width();
		innerText.css('font-size', fontSize);
		textWidth = innerText.width();
	
		if (textWidth > maxWidth) {
	
			do {
				innerText.css('font-size', fontSize);
			   
				textWidth = innerText.width();
				fontSize = fontSize - 1;

			 } while (textWidth > maxWidth && fontSize > 3);

		} else {
			do {
				innerText.css('font-size', fontSize);
			   
				textWidth = innerText.width();
				fontSize = fontSize + 1;

			 } while (textWidth < maxWidth && fontSize < 100);
		
		}

		lastWordSize = fontSize;
}

function debuglog(msg) {
	if (window.console && console.log) {
		console.log(msg);
	}

}

$(document).ready(function() {
	$("#pan").click(function() { setmode(this); });
	$("#select").click(function() { setmode(this); });
});

function setmode(item) {

	mode = $(item).attr('id');
	
	$(item).addClass('selected');

	mouse_mode = mode;
	if (mode == 'pan') {
		$("#select").removeClass('selected');
		
		$("#text_overlay").css('cursor', 'default');
		$("#text_overlay span").css('cursor', 'default');
	}

	if (mode == 'select') {
		$("#pan").removeClass('selected');
		$("#text_overlay").css('cursor', 'text');
		$("#text_overlay span").css('cursor', 'text');
	}
	
}


</script>

<link rel="stylesheet" href="css/ui-lightness/jquery-ui-1.8.10.custom.css" type="text/css" media="all" />

<style type="text/css">
#text_overlay {
	position: relative;
	border: 1px solid black;	
	height: 700px;
	width: 900px;
	background-repeat: no-repeat;
	display: inline-block;
}

#text_overlay span {
	cursor: default;
}

.text {
	color: rgba(0,0,0,0);

	
}

#top_toolbars {
	margin-left: 125px;
	width: 900px;
	clear:both;
	height: 28px;
}

#pages {
	display: inline-block;
}

#pages a {
	display: inline-block;
	margin-left: 4px;
	height: 24px;
	width: 24px;
	text-aling: center;
}

#pageChanger {

	width: 5ex;
	margin-left: 4px;
	text-align: center;
	height: 24px;
	vertical-align: top;
}

#toolbar {
	display: inline-block;
	float: right;
}

#toolbar div.selected {
	background-color: #dddddd;
}

#pages span {
	
	cursor: pointer;
	margin: 4px;
	
}
#index {
	display: inline-block;
	vertical-align: top;
	width: 120px;
}
#index .content_items li {
	cursor: pointer;
	list-style: none;
}

#imageindex {
	display: inline-block;
	width: 200px;
	height: 700px;
	border: 1px solid black;
	vertical-align: top;
}
#imageindex img {
	cursor: pointer;

}

.icon_pan {
	cursor: pointer;
	background-image: url(img/select_pan.png);
	width: 24px;
	height: 24px;
	border: 1px solid black;
	background-position: -24px 0px;
	display: inline-block;
}

.icon_select {
	cursor: pointer;
	background-image: url(img/select_pan.png);
	width: 24px;
	height: 24px;
	border: 1px solid black;
	display: inline-block;
}
</style>

</head>

<body>

<div id="top_toolbars">
<div id="pages">Sivu: </div>
<div id="toolbar"><div id="pan" class="selected icon_pan"></div><div id="select" class="icon_select"></div></div>
</div>

<div id="index">
Sisällysluettelo
	<div class="content_items"></div>
</div>


<div id="text_overlay"></div>

	<div id="imageindex">
	
		<div class="content_items">Latadataan</div>
	</div>


</body>

</html>
